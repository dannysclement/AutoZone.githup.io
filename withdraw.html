<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>Withdraw Money - Nigeria Online Banks</title>
  <style>
    /* General Styles */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .dashboard-container {
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 400px;
      margin: 10px;
      box-sizing: border-box;
    }

    /* Moving Message */
    .marquee {
      background: #007bff;
      color: #fff;
      padding: 10px;
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 20px;
      white-space: nowrap;
      position: relative;
      text-align: center;
    }

    .marquee span {
      display: inline-block;
      animation: scrollText 10s linear infinite;
      font-size: 14px;
    }

    @keyframes scrollText {
      0% {
        transform: translateX(100%);
      }
      100% {
        transform: translateX(-100%);
      }
    }

    /* Form Header */
    h2 {
      text-align: center;
      color: #444;
      font-size: 20px;
      margin-bottom: 20px;
    }

    /* Form Group */
    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      font-size: 14px;
    }

    .form-group select,
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }

    .form-group input:focus,
    .form-group select:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    }

    /* Submit Button */
    .btn {
      display: block;
      width: 100%;
      background: #007bff;
      color: #fff;
      padding: 12px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      text-align: center;
    }

    .btn:hover {
      background: #0056b3;
    }

    /* Hidden Fields */
    .hidden {
      display: none;
    }

    /* Note */
    .note {
      margin-top: 15px;
      font-size: 14px;
      text-align: center;
      color: #888;
    }

    /* Responsive Design */
    @media screen and (max-width: 768px) {
      .dashboard-container {
        padding: 20px;
      }

      h2 {
        font-size: 18px;
      }

      .form-group label {
        font-size: 13px;
      }

      .form-group select,
      .form-group input {
        font-size: 15px;
        padding: 8px;
      }

      .btn {
        font-size: 15px;
      }

      .marquee span {
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- Moving Welcome Message -->
    <div class="marquee">
      <span>Welcome! If you face any issues, kindly reach out to us or visit the **Invest** section for help.</span>
    </div>

    <!-- Withdraw Money Form -->
    <h2>Withdraw Money</h2>
    <form id="withdrawForm">
      <!-- Select Method -->
      <div class="form-group">
        <label for="method">Select Withdrawal Method</label>
        <select id="method" name="method" required>
          <option value="" disabled selected>-- Choose an option --</option>
          <option value="wallet">Wallet</option>
          <option value="onlineBank">Online Bank</option>
        </select>
      </div>

      <!-- Wallet Fields -->
      <div id="walletFields" class="hidden">
        <div class="form-group">
          <label for="walletId">Wallet ID</label>
          <input type="text" id="walletId" name="walletId" placeholder="Enter your wallet ID">
        </div>
        <div class="form-group">
          <label for="walletName">Wallet Name</label>
          <input type="text" id="walletName" name="walletName" placeholder="Enter your wallet name">
        </div>
      </div>

      <!-- Online Bank Fields -->
      <div id="bankFields" class="hidden">
        <div class="form-group">
          <label for="bankName">Select Online Bank</label>
          <select id="bankName" name="bankName" required>
            <option value="" disabled selected>-- Choose your bank --</option>
            <option value="opay">Opay</option>
            <option value="kuda">Kuda</option>
            <option value="palmpay">PalmPay</option>
            <option value="moniepoint">Moniepoint</option>
            <option value="fairmoney">FairMoney</option>
            <option value="rubies">Rubies Bank</option>
            <option value="vbank">V Bank</option>
            <option value="carbon">Carbon</option>
            <option value="eyowo">Eyowo</option>
            <option value="alajo">Alajo</option>
            <option value="onebank">OneBank</option>
            <option value="mintyn">Mintyn</option>
            <option value="squad">Squad</option>
            <option value="sparkle">Sparkle</option>
            <option value="providus">Providus Bank</option>
            <option value="bankly">Bankly</option>
            <option value="paycom">Paycom</option>
            <option value="zenith">Zenith Online Banking</option>
            <option value="firstmonie">FirstMonie</option>
            <option value="chippercash">Chipper Cash</option>
            <option value="paga">Paga</option>
          </select>
        </div>
        <div class="form-group">
          <label for="accountNumber">Account Number</label>
          <input type="text" id="accountNumber" name="accountNumber" placeholder="Enter your account number" required>
        </div>
        <div class="form-group">
          <label for="accountName">Account Name</label>
          <input type="text" id="accountName" name="accountName" placeholder="Enter your account name" required>
        </div>
      </div>

      <!-- Withdraw Amount -->
      <div class="form-group">
        <label for="withdrawAmount">Withdraw Amount</label>
        <input type="number" id="withdrawAmount" name="withdrawAmount" placeholder="Enter amount to withdraw" required>
      </div>

      <!-- Submit Button -->
      <button type="submit" class="btn">Withdraw</button>
    </form>
    <p class="note">Ensure your details are accurate to avoid transaction issues.</p>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Import the necessary Firebase functions
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, setDoc, collection } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBsQLHmUZUfmciuTIDWz4ezOZ3QTpyjg5M",
      authDomain: "invest-ad9f0.firebaseapp.com",
      projectId: "invest-ad9f0",
      storageBucket: "invest-ad9f0.firebasestorage.app",
      messagingSenderId: "539673203809",
      appId: "1:539673203809:web:ce4f05dc9a1a2a96174620",
      measurementId: "G-7WY9BZYZSM"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Check if user is logged in, else redirect to login page
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.replace("login.html");  // Redirect to login page if not logged in
      }
    });

    // Handle withdraw form submission
    document.getElementById('withdrawForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const user = auth.currentUser;
      const userId = user.uid; // Get user UID from Firebase Auth
      const method = document.getElementById('method').value;
      const withdrawAmount = parseFloat(document.getElementById('withdrawAmount').value);

      // Get user balance from Firestore
      const userRef = doc(db, "users", userId);
      const userSnap = await getDoc(userRef);

      if (userSnap.exists()) {
        const userData = userSnap.data();
        const currentBalance = userData.balance;

        // Check if the user has sufficient balance
        if (currentBalance >= withdrawAmount) {
          if (method === 'wallet') {
            const walletId = document.getElementById('walletId').value;
            const walletName = document.getElementById('walletName').value;

            // Check if the wallet exists in Firestore
            const walletRef = doc(db, "wallets", walletId);
            const walletSnap = await getDoc(walletRef);
            if (walletSnap.exists()) {
              // Proceed with wallet transaction (credit recipient and debit user)
              const walletData = walletSnap.data();
              const recipientBalance = walletData.balance;

              // Update the sender (user) balance
              const updatedSenderBalance = currentBalance - withdrawAmount;
              await updateDoc(userRef, { balance: updatedSenderBalance });

              // Credit the recipient's wallet
              const updatedRecipientBalance = recipientBalance + withdrawAmount;
              await updateDoc(walletRef, { balance: updatedRecipientBalance });

              // Store withdrawal transaction in Firestore
              await setDoc(doc(collection(db, "withdrawals")), {
                userId,
                amount: withdrawAmount,
                method: "wallet",
                walletId,
                walletName,
                timestamp: new Date(),
                status: 'success'
              });

              alert("Withdrawal successful! You will be credited within 5-10 minutes.");
              window.location.replace("account.html");  // Redirect after successful withdrawal
            } else {
              alert("Invalid wallet details.");
            }
          } else if (method === 'onlineBank') {
            const bankName = document.getElementById('bankName').value;
            const accountNumber = document.getElementById('accountNumber').value;
            const accountName = document.getElementById('accountName').value;

            // Store bank withdrawal transaction
            const updatedBalance = currentBalance - withdrawAmount;
            await updateDoc(userRef, { balance: updatedBalance });

            await setDoc(doc(collection(db, "withdrawals")), {
              userId,
              amount: withdrawAmount,
              method: "onlineBank",
              bankName,
              accountNumber,
              accountName,
              timestamp: new Date(),
              status: 'success'
            });

            alert("Withdrawal successful! You will be credited within 5-10 minutes.");
            window.location.replace("account.html");  // Redirect after successful withdrawal
          }
        } else {
          // Insufficient balance
          await setDoc(doc(collection(db, "withdrawals")), {
            userId,
            amount: withdrawAmount,
            method,
            timestamp: new Date(),
            status: 'failed'
          });
          alert("Insufficient balance. Please add funds.");
          window.location.replace("account.html");  // Redirect after failure
        }
      } else {
        alert("User not found.");
      }
    });
  </script>
</body>
</html>
